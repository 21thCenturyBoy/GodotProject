# 节点编辑器插件 (Node Editor Plugin)

## 概述 (Overview)

这是一个功能强大的Godot引擎节点编辑器插件，允许用户以可视化方式创建、编辑和管理节点图。它支持自定义节点类型、节点连接、拖放操作以及多种导入/导出格式，非常适合创建对话树、行为树、流程图或其他基于节点的可视化编程系统。

## 安装说明 (Installation)

1. 将 `node_editor_plugin` 文件夹复制到您的 Godot 项目的 `addons` 目录中
2. 在 Godot 编辑器中，进入 `项目 > 项目设置 > 插件`
3. 启用 "Node Editor Plugin"
4. 插件将自动注册并在编辑器中可用

## 主要功能 (Key Features)

- **节点管理**：创建、选择、删除和自定义节点
- **连接系统**：通过输入/输出槽创建节点间的连接
- **拖放操作**：直观地拖动和定位节点
- **自动排列**：一键排列节点，优化布局减少交叉线
- **画布操作**：拖动画布查看大型节点图
- **导入/导出**：支持多种格式保存和加载节点图
- **消息节点**：支持带文本编辑器的特殊消息节点

## 使用指南 (User Guide)

### 基本操作 (Basic Operations)

- **添加节点**：点击工具栏的"添加节点"按钮，从模板列表中选择节点类型
- **删除节点**：选中节点后，点击工具栏的"删除节点"按钮
- **选择节点**：点击节点可选中节点，点击空白区域取消选择
- **移动节点**：点击并拖动节点可改变其位置
- **调整节点大小**：拖动节点右下角可调整节点大小
- **拖动画布**：点击并拖动空白区域可移动整个画布视图

### 连接操作 (Connection Operations)

- **创建连接线**：
  1. 点击节点的输出槽（右侧红色圆点）
  2. 拖动鼠标到目标节点的输入槽（左侧绿色圆点）
  3. 释放鼠标完成连接
  
  *注意：只能从输出槽连接到输入槽，不能连接到同一节点*

- **删除连接线**：
  1. 右键点击连接线
  2. 在弹出菜单中选择"删除连接"

### 节点自动排列 (Auto Arrange)

- 点击工具栏的"Auto Arrange"按钮可自动排列所有节点
- 排列算法会优化节点布局，使节点横向排布，减少连接线交叉
- 排列后的节点会保持其连接关系不变

### 导入/导出功能 (Import/Export)

#### 导入选项
- **导入蓝图JSON文件**：加载标准格式的节点图JSON文件
- **导入自定义数据**：导入特定树形结构JSON数据并转换为节点图
  - 支持解析嵌套子节点结构
  - 自动创建节点连接
  - 支持消息节点的文本导入

#### 导出选项
- **导出蓝图JSON文件**：将节点图保存为标准JSON格式
- **导出自定义数据**：将节点图转换为树形结构的JSON格式
  - 支持将图转换为层次树结构
  - 提供复制到剪贴板功能
  - *注：目前仅支持导出消息节点类型*

## 节点类型 (Node Types)

### 基础节点 (Base Node)
- 通用节点类型，具有输入和输出槽
- 可以自定义名称和外观
- 支持拖放和连接操作

### 消息节点 (Message Node)
- 特殊节点类型，内置文本编辑器
- 用于存储和编辑文本消息
- 适合构建对话系统或文本流程

## 数据格式说明 (Data Format)

### 标准蓝图JSON格式
```json
{
  "nodes": [
    {
      "id": "Node_0",
      "name": "节点名称",
      "type": 4,
      "position": {"x": 100, "y": 200},
      "size": {"x": 200, "y": 150},
      "inputs": ["输入1"],
      "outputs": ["输出1"],
      "properties": { ... }
    }
  ],
  "connections": [
    {
      "from_node": "Node_0",
      "to_node": "Node_1", 
      "from_slot": 0,
      "to_slot": 0
    }
  ]
}
```

### 自定义数据格式
```json
{
  "case_name": "示例场景",
  "root_node": {
    "children": [
      {
        "children": [ ... ],
        "input_text": "节点文本内容",
        "node_name": "子节点名称",
        "node_type": "user_input"
      }
    ],
    "input_text": "",
    "node_name": "根节点名称",
    "node_type": "user_input"
  }
}
```

## 快捷键 (Shortcuts)

- **点击空白区域**：取消选择节点
- **点击并拖动空白区域**：移动画布
- **点击节点**：选中节点
- **点击并拖动节点**：移动节点
- **右键点击连接线**：显示连接线选项菜单

## 提示和技巧 (Tips & Tricks)

1. **使用自动排列功能**：当节点布局变得混乱时，使用自动排列功能可以快速整理
2. **先连接再移动**：先创建节点连接，然后使用自动排列，可以获得最佳布局效果
3. **导出前检查**：导出自定义数据前，确保所有节点都是消息节点类型
4. **导入自定义数据**：适合从外部树形结构导入数据并可视化编辑
5. **左上角信息**：查看左上角显示的画布名称和偏移信息

## 限制和注意事项 (Limitations & Notes)

1. 自定义数据导出目前仅支持消息节点类型
2. 每个节点只有一个输出槽，但可以连接到多个子节点
3. 自动排列后可能需要手动微调某些节点位置
4. 复杂的节点图可能会降低编辑器性能

## 故障排除 (Troubleshooting)

1. **如果节点无法拖动**：确保您点击的是节点区域，而不是内部控件
2. **如果连接线未显示**：检查连接是否正确创建，且节点未重叠
3. **导入失败**：确认JSON格式是否符合要求
4. **导出自定义数据失败**：检查是否有非消息节点，或者找不到根节点

## 未来计划 (Future Plans)

- 添加更多节点类型和模板
- 增强连接线样式和交互
- 实现节点组功能
- 添加撤销/重做功能
- 支持更多自定义样式和主题

## 开发说明

### 代码结构

- `node_editor_plugin.gd` - 插件入口
- `node_editor_view.gd` - 节点编辑器主视图
- `nodes/base_node.gd` - 基础节点类

### 连接线编辑逻辑

连接线的可视化编辑通过以下步骤实现：

1. 在节点的槽上检测鼠标点击事件
2. 当开始创建连接时，记录起始节点和槽的信息
3. 随着鼠标移动，绘制预览连接线
4. 释放鼠标时，检查目标槽是否有效，若有效则创建连接
